to create-uninfected-people
  create-people (population - infected-quantity)[
    let select-gender precision (random-float 1) 2
    
    ifelse (select-gender < 0.48)[
      set gender "male"
    ][
      set gender "female"
    ]
    set shape "person"
    set age random 70
    set district (random 19) + 1 
    set vulnerability_index 0.2
    
    set place_of_care "none"
    ; set mobility "" I'm not sure what values could have this field
    set status "uninfected"
    set level_of_infection "none"
    set time_infection 0
    set previous_medical_condition "none"
    set color white
    set size 1.5
    set xcor random-xcor
    set ycor random-ycor
    set viral_number 0
    
    if (show-age = true)[
      set label age
      set label-color red
    ]
  ]
end

to create-infected-people
  create-people infected-quantity [
    let select-gender precision (random-float 1) 2
    
    ifelse (select-gender < 0.48)[
      set gender "male"
    ][
      set gender "female"
    ]
    
    set shape "person"
    set age random 70
    set district (random 19) + 1 
    set vulnerability_index 0.2
    set place_of_care "home"
    ; set mobility "" I'm not sure what values could have this field
    set status "infected"
    set level_of_infection "low"
    set time_infection 1
    set previous_medical_condition "none"
    
    set color red
    set size 1.5
    set xcor random-xcor
    set ycor random-ycor
    set viral_number 1
    
    if (show-age = true)[
      set label age
      set label-color green
    ]
  ]
end

to step-people
  infected-people
  ifelse (not-move? = true)[
    ask people with[status != "infected"] [fd 1]
  ][
    ask people [fd 1]
  ]
  ask people with[status = "recovered"] [
    set personal-immunity-time personal-immunity-time - 1
    if (personal-immunity-time <= 0)[
      set status "uninfected"
      set color white
    ]
  ]
end

to infected-people
  ask people [
    right (random 360)
    let infected who
    ; Rule to infect an agent
    
    if (status = "infected")[
      set time_infection time_infection + 1
      
      ask people-here[
        let probability_of_contagion precision (random-float 1) 2
        ifelse reinfected? = true [
          if (distance myself < 0.5) and (probability_of_contagion <= 0.5) and (myself != self) and (status != "recovered") and (status != "infected")[
            ask self[
              set status "infected"
              set level_of_infection "low"
              set time_infection 1
              set previous_medical_condition "none"
              set viral_number probability_of_contagion
              ;set label probability_of_contagion
              set color red
              ;set label-color yellow
              if show-who-infected-who = true [
                create-link-with person infected
              ]
            ]
          ] 
        ][
          if (viral_number = 0) and (distance myself < 0.5) and (probability_of_contagion <= 0.5) and (myself != self)[
            ask self[
              set status "infected"
              set level_of_infection "low"
              set time_infection 1
              set previous_medical_condition "none"
              set viral_number probability_of_contagion
              ;set label probability_of_contagion
              set color red
              ;set label-color yellow
              ;create-link-with person infected
              if show-who-infected-who = true [
                create-link-with person infected
              ]
            ]
          ] 
        ]
      ]
      
      
      if ((min-illness-time <= time_infection) or (max-illness-time >= time_infection))[
        let probability_of_healing precision (random-float 1) 2
        
        if (probability_of_healing <= 0.03) and (time_infection > 360) [
          set status "recovered"
          set personal-immunity-time immunity-time * 24
          set color green
        ]
      ]
      
      if time_infection > dead-to-time [
        set number-of-deaths number-of-deaths + 1
        die
      ]
      
      
    ]
  ]
end